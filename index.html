<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Calendar Maker — presets, draggable, ZIP export</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --bg:#0f1115; --fg:#e8e8e8; --muted:#a6a6a6; --panel:#13161c; --line:#262a33;
    --accent:#5aa9ff; --guide:#78d1ff; --hud:#ffe16b;
  }
  html,body {margin:0; height:100%; background:var(--bg); color:var(--fg); font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .app {display:grid; grid-template-columns:360px 1fr; min-height:100vh}
  aside {background:var(--panel); border-right:1px solid var(--line); padding:10px 12px; overflow:auto}
  main {display:flex; flex-direction:column; gap:10px; padding:10px 12px}
  h2 {font-size:13px; color:var(--muted); margin:12px 0 6px; text-transform:uppercase; letter-spacing:.06em}
  .row {display:flex; gap:8px; align-items:center; margin-bottom:6px; flex-wrap:wrap}
  label {min-width:120px; color:var(--muted); font-size:12px}
  input[type="number"], input[type="text"], select {background:#161a20; color:var(--fg); border:1px solid #2a2f39; border-radius:.5rem; padding:.35rem .5rem; min-width:0}
  input[type="checkbox"]{transform:translateY(1px)}
  .grid2 {display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .btns {display:flex; gap:8px; flex-wrap:wrap; margin:10px 0}
  button {background:#172133; color:var(--fg); border:1px solid #2a3652; border-radius:.6rem; padding:.4rem .7rem; cursor:pointer}
  button:active{transform:translateY(1px)}
  .preview-wrap {position:relative; background:#0c0e12; border:1px solid var(--line); border-radius:.75rem; padding:8px; overflow:auto}
  .bar {display:flex; gap:8px; align-items:center; justify-content:space-between}
  .hint {color:#9fb8ff; font-size:12px}
  .guide {stroke:var(--guide); stroke-width:1.5; stroke-dasharray:6 4; fill:none}
  .handle {fill:#0c1829; stroke:var(--guide); stroke-width:1.5}
  .hud {position:absolute; z-index:10; background:var(--hud); color:#000; padding:2px 6px; border-radius:.35rem; font-size:12px; border:1px solid #b89c2a; pointer-events:none}
</style>
</head>
<body>
<div class="app">
  <aside>
    <h2>Language</h2>
    <div class="grid2">
      <div class="row"><label>Preset</label>
        <select id="lang">
          <option value="ENG">ENG — English</option>
          <option value="CZE">CZE — Čeština</option>
          <option value="JA">JA — 日本語</option>
        </select>
      </div>
      <div class="row"><label>Full names</label><input id="fullNames" type="checkbox"></div>
    </div>

    <h2>Document</h2>
    <div class="row">
      <label>Preset</label>
      <select id="pagePreset">
        <option value="A4P">A4 Portrait (210×297)</option>
        <option value="A4L">A4 Landscape (297×210)</option>
        <option value="A5P">A5 Portrait (148×210)</option>
        <option value="A5L">A5 Landscape (210×148)</option>
        <option value="B5P">B5 Portrait (176×250)</option>
        <option value="B5L">B5 Landscape (250×176)</option>
        <option value="B4P">B4 Portrait (250×353)</option>
        <option value="B4L">B4 Landscape (353×250)</option>
        <option value="CUSTOM">Custom (mm)</option>
      </select>
    </div>
    <div class="grid2">
      <div class="row"><label>Page W (mm)</label><input id="pageW" type="number" value="210" step="1"></div>
      <div class="row"><label>Page H (mm)</label><input id="pageH" type="number" value="297" step="1"></div>
    </div>

    <h2>Calendar Block (mm)</h2>
    <div class="grid2">
      <div class="row"><label>X</label><input id="calX" type="number" value="15" step=".5"></div>
      <div class="row"><label>Y</label><input id="calY" type="number" value="150" step=".5"></div>
      <div class="row"><label>Width</label><input id="calW" type="number" value="180" step=".5"></div>
      <div class="row"><label>Height</label><input id="calH" type="number" value="120" step=".5"></div>
    </div>
    <div class="row"><label>Show guides</label><input id="showGuides" type="checkbox" checked></div>

    <h2>Month & Locale</h2>
    <div class="grid2">
      <div class="row"><label>Year</label><input id="year" type="number" value="2026"></div>
      <div class="row"><label>Month</label>
        <select id="month">
          <script>
            (()=>{ const ms=[1,2,3,4,5,6,7,8,9,10,11,12];
              document.currentScript.outerHTML = ms.map((m,i)=>`<option value="${i}">${m}</option>`).join("");
            })();
          </script>
        </select>
      </div>
    </div>
    <div class="row"><label>First day</label>
      <select id="firstDay"><option value="0">Sunday</option><option value="1">Monday (ISO)</option></select>
    </div>

    <h2>Header</h2>
    <div class="row"><label>Text</label><input id="hdrText" type="text" value="{MONTH} {YEAR}"></div>
    <div class="grid2">
      <div class="row"><label>Font</label><input id="hdrFont" type="text" value="Inter, Arial"></div>
      <div class="row"><label>Size (pt)</label><input id="hdrSize" type="number" value="18" step=".5"></div>
    </div>
    <div class="grid2">
      <div class="row"><label>Align</label>
        <select id="hdrAlign"><option value="left">Left</option><option value="center">Center</option><option value="right">Right</option></select>
      </div>
      <div class="row"><label>Margin B (mm)</label><input id="hdrGap" type="number" value="6" step=".5"></div>
    </div>

    <h2>Grid & Cells</h2>
    <div class="grid2">
      <div class="row"><label>Stroke (pt)</label><input id="cellStrokePt" type="number" value="0.6" step=".1"></div>
      <div class="row"><label>Radius (mm)</label><input id="cellRadius" type="number" value="2" step=".2"></div>
    </div>
    <div class="grid2">
      <div class="row"><label>Gutter X (mm)</label><input id="gutX" type="number" value="2" step=".2"></div>
      <div class="row"><label>Gutter Y (mm)</label><input id="gutY" type="number" value="2" step=".2"></div>
    </div>
    <div class="grid2">
      <div class="row"><label>Table lines</label><input id="tableLines" type="checkbox"></div>
      <div class="row"><label>Hide empty cells</label><input id="hideEmpty" type="checkbox"></div>
    </div>
    <div class="grid2">
      <div class="row"><label>Prev/next numbers</label><input id="showAdj" type="checkbox"></div>
      <div class="row"><label>(tone) Adj shade %</label><input id="adjAlpha" type="number" value="55" min="10" max="90" step="5"></div>
    </div>

    <h2>Day Number</h2>
    <div class="grid2">
      <div class="row"><label>Font</label><input id="dayFont" type="text" value="Inter, Arial"></div>
      <div class="row"><label>Size (pt)</label><input id="daySizePt" type="number" value="9" step=".5"></div>
    </div>
    <div class="grid2">
      <div class="row"><label>Offset X (mm)</label><input id="dayOffX" type="number" value="-1.5" step=".2"></div>
      <div class="row"><label>Offset Y (mm)</label><input id="dayOffY" type="number" value="1.5" step=".2"></div>
    </div>
    <div class="row"><label>Anchor</label>
      <select id="dayAnchor">
        <option value="top-right">Top-Right</option>
        <option value="top-left">Top-Left</option>
        <option value="center">Center</option>
        <option value="bottom-right">Bottom-Right</option>
      </select>
    </div>

    <div class="btns">
      <button id="generate">Generate All (preview & ZIP)</button>
    </div>
  </aside>

  <main>
    <div class="bar">
      <span class="hint">Preview (scaled). Drag or resize the cyan rectangle; HUD shows mm in the foreground.</span>
      <div>
        <label>Month</label>
        <select id="monthTop"></select>
        <button id="prevM">◀</button><button id="nextM">▶</button>
      </div>
    </div>
    <div class="preview-wrap" id="preview"><div id="hud" class="hud" style="display:none"></div></div>
  </main>
</div>

<script>
/* ===== Data & utils ===== */
const PX_PER_MM = 96/25.4; const mm=v=>v*PX_PER_MM; const ptToPx=pt=>pt*(96/72);
const clamp=(x,a,b)=>Math.min(b,Math.max(a,x)); const r1=v=>Math.round(v*10)/10;

function isLeap(y){ return (y%4===0 && y%100!==0) || (y%400===0); }
function daysInMonth(y,m){ return [31,isLeap(y)?29:28,31,30,31,30,31,31,30,31,30,31][m]; }
function firstWeekday(y,m, firstDay){ const d=new Date(y,m,1).getDay(); return (d-firstDay+7)%7; }

const MONTH_EN = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const MONTH_CZ = ["Leden","Únor","Březen","Duben","Květen","Červen","Červenec","Srpen","Září","Říjen","Listopad","Prosinec"];
const MONTH_JA = Array.from({length:12},(_,i)=>`${i+1}月`);
const WD_EN_S = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const WD_EN_F = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const WD_CZ_S = ["Ne","Po","Út","St","Čt","Pá","So"];         // base: Sunday first
const WD_CZ_F = ["Neděle","Pondělí","Úterý","Středa","Čtvrtek","Pátek","Sobota"];
const WD_JA_S = ["日","月","火","水","木","金","土"];
const WD_JA_F = ["日曜日","月曜日","火曜日","水曜日","木曜日","金曜日","土曜日"];

const state = {
  lang:"ENG", fullNames:false,
  pageW:210, pageH:297, preset:"A4P",
  year:(new Date()).getFullYear(), month:(new Date()).getMonth(), firstDay:0,
  calX:15, calY:150, calW:180, calH:120, showGuides:true,
  hdrText:"{MONTH} {YEAR}", hdrFont:"Inter, Arial", hdrSizePt:18, hdrAlign:"left", hdrGap:6,
  cellStrokePt:0.6, cellRadius:2, gutX:2, gutY:2,
  tableLines:false, hideEmpty:false, showAdj:false, adjAlpha:55,
  dayFont:"Inter, Arial", daySizePt:9, dayOffX:-1.5, dayOffY:1.5, dayAnchor:"top-right"
};

const $=id=>document.getElementById(id);
const previewHost = $("preview");
let hud = $("hud");

function langMonths(){ return state.lang==="ENG"?MONTH_EN : state.lang==="CZE"?MONTH_CZ : MONTH_JA; }
function langWeekdaysBase(){
  const short = state.lang==="ENG"?WD_EN_S : state.lang==="CZE"?WD_CZ_S : WD_JA_S;
  const full  = state.lang==="ENG"?WD_EN_F : state.lang==="CZE"?WD_CZ_F : WD_JA_F;
  return state.fullNames? full : short;
}
function langWeekdays(){
  // Rotate to match firstDay (0=Sun). Arrays above are Sunday-first.
  const base = langWeekdaysBase().slice();
  if (state.firstDay===0) return base;
  return base.slice(1).concat(base.slice(0,1));
}

/* ===== Wiring (live apply) ===== */
function bindNum(id,key){ const e=$(id); const fn=()=>{ state[key]=parseFloat(e.value)||0; render(); }; e.addEventListener("input",fn); state[key]=parseFloat(e.value)||state[key]; }
function bindTxt(id,key){ const e=$(id); const fn=()=>{ state[key]=e.value; render(); }; e.addEventListener("input",fn); state[key]=e.value; }
function bindSel(id,key,isInt=false){ const e=$(id); const fn=()=>{ state[key]=isInt?parseInt(e.value):e.value; render(); }; e.addEventListener("change",fn); state[key]=isInt?parseInt(e.value):e.value; }
function bindChk(id,key){ const e=$(id); const fn=()=>{ state[key]=e.checked; render(); }; e.addEventListener("change",fn); state[key]=e.checked; }

(function wire(){
  // Language
  bindSel("lang","lang"); bindChk("fullNames","fullNames");

  // Preset sizes
  bindSel("pagePreset","preset");
  $("pagePreset").addEventListener("change", ()=>{
    const p=$("pagePreset").value;
    const map={A4P:[210,297],A4L:[297,210],A5P:[148,210],A5L:[210,148],B5P:[176,250],B5L:[250,176],B4P:[250,353],B4L:[353,250]};
    if(map[p]){ $("pageW").value=map[p][0]; $("pageH").value=map[p][1]; state.pageW=map[p][0]; state.pageH=map[p][1]; render(); }
  });
  bindNum("pageW","pageW"); bindNum("pageH","pageH");

  // Block
  ["calX","calY","calW","calH"].forEach(k=>bindNum(k,k));
  bindChk("showGuides","showGuides");

  // Month/locale
  bindNum("year","year"); bindSel("month","month",true); bindSel("firstDay","firstDay",true);
  const mt=$("monthTop"); mt.innerHTML=Array.from({length:12},(_,i)=>`<option value="${i}">${i+1}</option>`).join("");
  mt.value=state.month; $("month").value=state.month;
  mt.addEventListener("change",()=>{ state.month=parseInt(mt.value); $("month").value=state.month; render(); });
  $("prevM").onclick=()=>{ state.month=(state.month+11)%12; mt.value=state.month; $("month").value=state.month; render(); };
  $("nextM").onclick=()=>{ state.month=(state.month+1)%12; mt.value=state.month; $("month").value=state.month; render(); };

  // Header
  bindTxt("hdrText","hdrText"); bindTxt("hdrFont","hdrFont");
  bindNum("hdrSize","hdrSizePt"); bindSel("hdrAlign","hdrAlign"); bindNum("hdrGap","hdrGap");

  // Grid/cells
  bindNum("cellStrokePt","cellStrokePt"); bindNum("cellRadius","cellRadius");
  bindNum("gutX","gutX"); bindNum("gutY","gutY");
  bindChk("tableLines","tableLines"); bindChk("hideEmpty","hideEmpty");
  bindChk("showAdj","showAdj"); bindNum("adjAlpha","adjAlpha");

  // Day numbers
  bindTxt("dayFont","dayFont"); bindNum("daySizePt","daySizePt");
  bindNum("dayOffX","dayOffX"); bindNum("dayOffY","dayOffY"); bindSel("dayAnchor","dayAnchor");

  // Generate
  $("generate").onclick=()=>openPreviewAndZip();
})();

/* ===== Rendering ===== */
function buildMonthSVG(y,mIdx, {exportMode=false}={}){
  const svgns="http://www.w3.org/2000/svg";
  const svg=document.createElementNS(svgns,"svg");
  svg.setAttribute("xmlns","http://www.w3.org/2000/svg");
  svg.setAttribute("width", state.pageW+"mm");
  svg.setAttribute("height", state.pageH+"mm");
  svg.setAttribute("viewBox", `0 0 ${mm(state.pageW)} ${mm(state.pageH)}`);

  // Page white background to avoid black fills in some viewers
  const page=document.createElementNS(svgns,"rect");
  page.setAttribute("x",0); page.setAttribute("y",0);
  page.setAttribute("width",mm(state.pageW)); page.setAttribute("height",mm(state.pageH));
  page.setAttribute("fill","#ffffff");
  svg.appendChild(page);

  // Calendar group
  const g=document.createElementNS(svgns,"g");
  g.setAttribute("transform", `translate(${mm(state.calX)}, ${mm(state.calY)})`);
  svg.appendChild(g);

  // Header
  const months=langMonths();
  const title=(state.hdrText||"").replace("{MONTH}", months[mIdx]).replace("{YEAR}", String(y));
  const hdr=document.createElementNS(svgns,"text");
  hdr.setAttribute("font-family", state.hdrFont);
  hdr.setAttribute("font-size", ptToPx(state.hdrSizePt));
  hdr.setAttribute("dominant-baseline","hanging");
  hdr.setAttribute("fill","#000");
  let tx=0, ta="start"; if (state.hdrAlign==="center"){ tx=mm(state.calW)/2; ta="middle"; } if (state.hdrAlign==="right"){ tx=mm(state.calW); ta="end"; }
  hdr.setAttribute("x",tx); hdr.setAttribute("y",0); hdr.setAttribute("text-anchor",ta);
  hdr.textContent=title; g.appendChild(hdr);

  const hdrGapPx=mm(state.hdrGap);
  const gridY0 = ptToPx(state.hdrSizePt) + hdrGapPx;

  // Geometry
  const cols=7, rows=6;
  const gutX=mm(state.gutX), gutY=mm(state.gutY);
  const gridW=mm(state.calW), gridH=mm(state.calH)-gridY0;
  const cellW=(gridW - gutX*(cols-1)) / cols;
  const cellH=(gridH - gutY*(rows-1)) / rows;

  // Weekday row
  const dnames = langWeekdays();
  dnames.forEach((d,i)=>{
    const t=document.createElementNS(svgns,"text");
    t.setAttribute("x", i*(cellW+gutX)+cellW/2);
    t.setAttribute("y", gridY0 - (gutY>2?gutY/2:2));
    t.setAttribute("font-family", state.dayFont);
    t.setAttribute("font-size", ptToPx( state.fullNames? 9.5 : 8 ));
    t.setAttribute("fill","#333");
    t.setAttribute("text-anchor","middle");
    t.textContent=d;
    g.appendChild(t);
  });

  // Month math
  const startOff = firstWeekday(y,mIdx,state.firstDay);
  const days = daysInMonth(y,mIdx);
  // Adjacent month numbers
  const prevMonth = (mIdx+11)%12;
  const nextMonth = (mIdx+1)%12;
  const daysPrev = daysInMonth(y - (mIdx===0?1:0), prevMonth);

  let n=1, trailing=1;

  // Table lines mode
  if (state.tableLines){
    // Outer border
    const border=document.createElementNS(svgns,"rect");
    border.setAttribute("x",0); border.setAttribute("y",gridY0);
    border.setAttribute("width",gridW); border.setAttribute("height",gridH);
    border.setAttribute("fill","none");
    border.setAttribute("stroke","#000");
    border.setAttribute("stroke-width", ptToPx(state.cellStrokePt));
    g.appendChild(border);
    // Vertical dividers
    for (let c=1;c<cols;c++){
      const x=c*(cellW+gutX)-gutX/2;
      const line=document.createElementNS(svgns,"line");
      line.setAttribute("x1",x); line.setAttribute("y1",gridY0);
      line.setAttribute("x2",x); line.setAttribute("y2",gridY0+gridH);
      line.setAttribute("stroke","#000"); line.setAttribute("stroke-width", ptToPx(state.cellStrokePt));
      g.appendChild(line);
    }
    // Horizontal dividers
    for (let r=1;r<rows;r++){
      const y=gridY0 + r*(cellH+gutY) - gutY/2;
      const line=document.createElementNS(svgns,"line");
      line.setAttribute("x1",0); line.setAttribute("y1",y);
      line.setAttribute("x2",gridW); line.setAttribute("y2",y);
      line.setAttribute("stroke","#000"); line.setAttribute("stroke-width", ptToPx(state.cellStrokePt));
      g.appendChild(line);
    }
  }

  for (let r=0;r<rows;r++){
    for (let c=0;c<cols;c++){
      const idx = r*cols+c;
      const x=c*(cellW+gutX), y=gridY0 + r*(cellH+gutY);

      let isActive=false, label="", isAdj=false, adjFromPrev=false;
      if (idx<startOff){ // leading cells
        if (state.hideEmpty && !state.showAdj) continue;
        if (state.showAdj){ label = String(daysPrev - (startOff-1 - idx)); isAdj=true; adjFromPrev=true; }
      } else if (n<=days){ // current month
        isActive=true; label=String(n++);
      } else { // trailing cells
        if (state.hideEmpty && !state.showAdj) continue;
        if (state.showAdj){ label=String(trailing++); isAdj=true; }
      }

      // draw cell background only if not tableLines
      if (!state.tableLines){
        const rect=document.createElementNS(svgns,"rect");
        rect.setAttribute("x",x); rect.setAttribute("y",y);
        rect.setAttribute("width",cellW); rect.setAttribute("height",cellH);
        rect.setAttribute("rx", mm(state.cellRadius));
        rect.setAttribute("fill", isActive? "#ffffff" : "#f6f6f6");
        rect.setAttribute("stroke", state.cellStrokePt>0? "#000":"none");
        rect.setAttribute("stroke-width", ptToPx(state.cellStrokePt));
        g.appendChild(rect);
      }

      if (label){
        const dn=document.createElementNS(svgns,"text");
        dn.setAttribute("font-family", state.dayFont);
        dn.setAttribute("font-size", ptToPx(state.daySizePt));
        dn.setAttribute("fill", isAdj? `rgba(0,0,0,${clamp(state.adjAlpha,10,90)/100})` : "#000");
        let ax,ay; const dx=mm(state.dayOffX), dy=mm(state.dayOffY);
        const anch=state.dayAnchor;
        if (anch==="top-right"){ ax=x+cellW+dx; ay=y+dy; dn.setAttribute("text-anchor","end"); dn.setAttribute("dominant-baseline","hanging"); }
        else if (anch==="top-left"){ ax=x+dx; ay=y+dy; dn.setAttribute("text-anchor","start"); dn.setAttribute("dominant-baseline","hanging"); }
        else if (anch==="center"){ ax=x+cellW/2+dx; ay=y+cellH/2+dy; dn.setAttribute("text-anchor","middle"); dn.setAttribute("dominant-baseline","middle"); }
        else { ax=x+cellW+dx; ay=y+cellH+dy; dn.setAttribute("text-anchor","end"); dn.setAttribute("dominant-baseline","ideographic"); }
        dn.setAttribute("x",ax); dn.setAttribute("y",ay);
        dn.textContent=label;
        g.appendChild(dn);
      }
    }
  }

  // Cyan draggable overlay (preview only)
  if (state.showGuides && !exportMode){
    const overlay=document.createElementNS(svgns,"g");
    overlay.setAttribute("data-overlay","1");
    overlay.setAttribute("transform", `translate(${mm(state.calX)}, ${mm(state.calY)})`);
    const r=document.createElementNS(svgns,"rect");
    r.setAttribute("x",-mm(state.calX)); r.setAttribute("y",-mm(state.calY)); // page-relative, we’ll reposition via JS
    r.setAttribute("width",mm(state.calW)); r.setAttribute("height",mm(state.calH));
    r.removeAttribute("x"); r.removeAttribute("y"); // ensure only transform affects position
    r.setAttribute("class","guionst innerW = W - mLeft - mRight;
    const innerH = H - mTop - mBottom - settings.hdrSize - hdrGap;
    const cellW = (innerW - gutterX*(cols-1)) / cols;
    const cellH = (innerH - gutterY*(rows-1)) / rows;
    const gridY = mTop + settings.hdrSize + hdrGap;

    function mkGuideLine(x1,y1,x2,y2, key){
      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute("x1",x1); line.setAttribute("y1",y1);
      line.setAttribute("x2",x2); line.setAttribute("y2",y2);
      line.setAttribute("stroke","var(--guide)");
      line.setAttribute("stroke-width","2.5");
      line.setAttribute("opacity","0.9");
      line.classList.add("guide");
      line.style.cursor = (key==='mTop' || key==='row') ? "ns-resize" : "ew-resize";
      line.addEventListener("pointerdown", (e)=>{ activeGuide = {key, startX:e.clientX, startY:e.clientY}; e.target.setPointerCapture(e.pointerId); });
      line.addEventListener("pointermove", (e)=>{
        if (!activeGuide) return;
        if (activeGuide.key !== key) return;
        const dy = e.clientY - activeGuide.startY;
        const dx = e.clientX - activeGuide.startX;

        // Update shared layout with clamped values
        if (key==='mTop'){
          layout.mTop = clamp(mTop + dy, 10, H*0.4);
        } else if (key==='mLeft'){
          layout.mLeft = clamp(mLeft + dx, 8, W*0.4);
        } else if (key==='col'){ // gutterX
          layout.gutterX = clamp(gutterX + dx*0.05, 0, 30);
        } else if (key==='row'){ // gutterY
          layout.gutterY = clamp(gutterY + dy*0.05, 0, 30);
        }
        renderAll(); // propagate to all months
      });
      line.addEventListener("pointerup", ()=>{ activeGuide = null; });
      svg.appendChild(line);

      // Label
      const lbl = document.createElement("div");
      lbl.className = "guide-label";
      lbl.textContent = labelText(key);
      card.appendChild(lbl);
      // Position label near the line
      const rect = svg.getBoundingClientRect();
      positionLabel(lbl, rect, x1,y1,x2,y2);
    }

    // Top margin guide
    mkGuideLine(8, mTop, W-8, mTop, 'mTop');
    // Left margin guide
    mkGuideLine(mLeft, 8, mLeft, H-8, 'mLeft');
    // Column gutter guide (between col0 and col1)
    mkGuideLine(mLeft + cellW + gutterX/2, gridY, mLeft + cellW + gutterX/2, gridY + rows*cellH + (rows-1)*gutterY, 'col');
    // Row gutter guide (between row0 and row1)
    mkGuideLine(mLeft, gridY + cellH + gutterY/2, mLeft + cols*cellW + (cols-1)*gutterX, gridY + cellH + gutterY/2, 'row');
  });
}
function labelText(key){
  if (key==='mTop') return `Top margin: ${layout.mTop.toFixed(0)}px`;
  if (key==='mLeft') return `Left margin: ${layout.mLeft.toFixed(0)}px`;
  if (key==='col') return `Column gutter: ${layout.gutterX.toFixed(1)}px`;
  if (key==='row') return `Row gutter: ${layout.gutterY.toFixed(1)}px`;
  return key;
}
function positionLabel(lbl, rect, x1,y1,x2,y2){
  // Place near the center of the line
  const cx = (x1+x2)/2, cy = (y1+y2)/2;
  lbl.style.left = `${rect.left + window.scrollX + cx + 8}px`;
  lbl.style.top  = `${rect.top  + window.scrollY + cy + 8}px`;
}

// --- Clamp ---
function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }

// --- Hook up controls ---
function wireUI(){
  const bindings = [
    ["#year", "year", parseInt],
    ["#firstDay","firstDay", parseInt],
    ["#fontFamily","fontFamily", v=>v],
    ["#hdrSize","hdrSize", v=>parseFloat(v)||20],
    ["#daySize","daySize", v=>parseFloat(v)||14],
    ["#stroke","stroke", v=>parseFloat(v)||1],
    ["#radius","radius", v=>parseFloat(v)||8],
  ];
  bindings.forEach(([sel,key,cast])=>{
    const el = $(sel);
    el.value = settings[key];
    el.addEventListener("input", ()=>{
      settings[key] = cast(el.value);
      renderAll();
    });
  });
}

// --- Init ---
(function init(){
  wireUI();
  // seed with current year in local timezone
  const now = new Date();
  settings.year = now.getFullYear();
  $("#year").value = settings.year;
  renderAll();
})();
</script>
</body>
</html>
